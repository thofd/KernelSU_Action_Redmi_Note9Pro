name: Build SukiSU-Ultra Kernel for Gauguin

on:
  workflow_dispatch:

jobs:
  build:
    name: Compile Kernel
    runs-on: ubuntu-22.04

    steps:

    - name: âœ… åˆå§‹åŒ–å·¥ä½œç›®å½•
      run: |
        mkdir kernel clang anykernel

    - name: ğŸ§¬ å…‹éš† gauguin å®˜æ–¹å†…æ ¸ï¼ˆAndroid 12ï¼‰
      run: |
        git clone --depth=1 https://github.com/thofd/neko_kernel_xiaomi_gauguin -b main kernel

    - name: ğŸ§° å…‹éš† Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: ğŸŒŸ é›†æˆ SukiSU-Ultra æ¨¡å—
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-dev

    - name: âš™ï¸ è®¾ç½®æ„å»ºå˜é‡
      run: |
        echo "KERNEL_DIR=$GITHUB_WORKSPACE/kernel" >> $GITHUB_ENV
        echo "CLANG_PATH=$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_ENV
        echo "ANYKERNEL_DIR=$GITHUB_WORKSPACE/anykernel" >> $GITHUB_ENV

    - name: ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential flex libssl-dev \
          libelf-dev libncurses5-dev curl ccache python3 unzip zip wget

    - name: ğŸ§ª é…ç½®å¹¶ç¼–è¯‘å†…æ ¸
      run: |
        cd $KERNEL_DIR
        export PATH=$CLANG_PATH:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=clang

        make O=out gauguin_defconfig

        # å¼ºåˆ¶å¯ç”¨ SukiSU/SUSFS/KPM
        sed -i '/CONFIG_SUKISU/d' out/.config
        sed -i '/CONFIG_SUSFS/d' out/.config
        sed -i '/CONFIG_KPM/d' out/.config
        echo "CONFIG_SUKISU=y" >> out/.config
        echo "CONFIG_SUSFS=y" >> out/.config
        echo "CONFIG_KPM=y" >> out/.config

        make O=out CC=clang -j$(nproc)

        # å¤åˆ¶è£¸ Image æ–‡ä»¶
        cp out/arch/arm64/boot/Image $GITHUB_WORKSPACE/Image

    - name: ğŸ› ï¸ å…‹éš†å¹¶å‡†å¤‡ AnyKernel3
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 $ANYKERNEL_DIR
        cp $GITHUB_WORKSPACE/Image $ANYKERNEL_DIR/Image
        
        # ç”¨æˆ‘ä»¬è‡ªå·±æ”¹è¿‡çš„ anykernel.sh è¦†ç›–
        curl -LSs https://yourlink.com/your-anykernel.sh -o $ANYKERNEL_DIR/anykernel.sh
        chmod +x $ANYKERNEL_DIR/anykernel.sh

    - name: ğŸ“¦ æ‰“åŒ… zip
      run: |
        cd $ANYKERNEL_DIR
        zip -r9 SukiSU_Gauguin.zip *

    - name: ğŸš€ ä¸Šä¼ ç¼–è¯‘ç»“æœ
      uses: actions/upload-artifact@v3
      with:
        name: SukiSU_Gauguin
        path: anykernel/SukiSU_Gauguin.zip
